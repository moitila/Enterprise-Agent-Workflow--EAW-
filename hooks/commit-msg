#!/usr/bin/env bash
# Commit-msg hook to enforce EAW Commit Standard (ECS)
set -euo pipefail

MSG_FILE="${1:-}" 
if [[ -z "$MSG_FILE" ]]; then
  echo "[ECS] commit-msg hook: missing commit message file argument" >&2
  exit 1
fi

read_first_line() {
  head -n1 "$MSG_FILE" || true
}

msg_subject=$(read_first_line)

# Validate subject: type(work-type): summary
if ! [[ "$msg_subject" =~ ^(feat|fix|refactor|docs|chore|test)\((feature|spike|bug)\):[[:space:]]+.+ ]]; then
  echo "[ECS] Invalid commit header. Expected format:" >&2
  echo "  <type>(<work-type>): <summary>" >&2
  echo "  where <type> in [feat|fix|refactor|docs|chore|test] and <work-type> in [feature|spike|bug]" >&2
  echo "Offending header: '$msg_subject'" >&2
  exit 1
fi

# Helper to find metadata lines (case-sensitive keys)
find_meta() {
  local key="$1"
  grep -E "^\[$key\]:" "$MSG_FILE" || true
}

check_presence_and_value() {
  local key="$1"; shift
  local allowed=("$@")
  local line
  line=$(find_meta "$key") || true
  if [[ -z "$line" ]]; then
    echo "[ECS] Missing required metadata line: [$key]: <value>" >&2
    exit 1
  fi
  # extract value after colon
  local val
  val=$(echo "$line" | sed -E "s/^\[$key\]:[[:space:]]*//")
  if [[ -z "$val" ]]; then
    echo "[ECS] Metadata [$key] must not be empty" >&2
    exit 1
  fi
  if [[ ${#allowed[@]} -gt 0 ]]; then
    local match=0
    for a in "${allowed[@]}"; do
      if [[ "$val" == "$a" ]]; then
        match=1
        break
      fi
    done
    if [[ $match -ne 1 ]]; then
      echo "[ECS] Invalid value for [$key]: '$val'" >&2
      echo "       Allowed: ${allowed[*]}" >&2
      exit 1
    fi
  fi
}

# Validate required metadata and allowed values
check_presence_and_value "Risk-Level" low medium high
check_presence_and_value "Impact-Scope" local module "cross-module" system
check_presence_and_value "Phase" analysis implementation validation

# EAW-ID: just check presence and non-empty
check_presence_and_value "EAW-ID"

# Passed all checks
exit 0
